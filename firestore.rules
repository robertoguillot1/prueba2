rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper: Usuario autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // ===============================================
    // SISTEMA PRINCIPAL: Clean Architecture
    // ===============================================
    
    // Fincas principales (sistema nuevo Clean Architecture)
    match /farms/{farmId} {
      // Permitir lectura/escritura si el usuario est치 autenticado
      allow read, write: if isAuthenticated();

      // Bovinos/Cattle de la finca
      match /cattle/{cattleId} {
        allow read, write: if isAuthenticated();

        // Subcolecciones de bovinos:
        // - vacunas (vaccines)
        // - pesos (weight_records)
        // - eventos reproductivos (reproductive_events)
        // - producci칩n de leche (milk_production)
        // - transferencias (transfers)
        match /{subcollection=**} {
          allow read, write: if isAuthenticated();
        }
      }

      // Finanzas de la finca
      match /expenses/{expenseId} {
        allow read, write: if isAuthenticated();
      }

      match /loans/{loanId} {
        allow read, write: if isAuthenticated();
      }

      match /payments/{paymentId} {
        allow read, write: if isAuthenticated();
      }

      // Trabajadores de la finca
      match /workers/{workerId} {
        allow read, write: if isAuthenticated();

        // Subcolecciones de trabajadores:
        // - pagos
        // - prestamos
        match /pagos/{pagoId} {
          allow read, write: if isAuthenticated();
        }

        match /prestamos/{prestamoId} {
          allow read, write: if isAuthenticated();
        }
      }
    }

    // ===============================================
    // DATOS DE USUARIO (perfil, configuraci칩n)
    // ===============================================
    match /users/{userId} {
      // Permitir al usuario leer/escribir solo sus propios datos
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Fincas del usuario (SOLO para compatibilidad con m칩dulo de fincas)
      // Esta ruta almacena: users/{userId}/farms/{farmId}
      match /farms/{farmId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}